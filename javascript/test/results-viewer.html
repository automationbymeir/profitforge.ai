<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProfitForge.ai - Results Viewer</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.6;
        max-width: 1400px;
        margin: 40px auto;
        padding: 20px;
        color: #333;
        background: #f5f5f5;
      }

      h1 {
        color: #0078d4;
        border-bottom: 2px solid #0078d4;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }

      .subtitle {
        color: #666;
        font-size: 1.1em;
        margin-bottom: 30px;
      }

      .controls {
        background: #f9f9f9;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .form-group {
        flex: 1;
        min-width: 200px;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #0078d4;
      }

      button {
        background: #0078d4;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.2s;
        white-space: nowrap;
      }

      button:hover {
        background: #005a9e;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      button.secondary {
        background: #6c757d;
      }

      button.secondary:hover {
        background: #5a6268;
      }

      button.danger {
        background: #dc3545;
      }

      button.danger:hover {
        background: #c82333;
      }

      button.success {
        background: #28a745;
      }

      button.success:hover {
        background: #218838;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
      }

      .results-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .card-header {
        background: #0078d4;
        color: white;
        padding: 20px 25px;
      }

      .card-header h2 {
        font-size: 1.5em;
        margin-bottom: 5px;
      }

      .card-meta {
        opacity: 0.9;
        font-size: 0.9em;
      }

      .card-body {
        padding: 25px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 2px solid #f0f0f0;
      }

      .info-item {
        display: flex;
        flex-direction: column;
      }

      .info-label {
        font-size: 0.85em;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
      }

      .info-value {
        font-size: 1.1em;
        font-weight: 600;
        color: #333;
      }

      .status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
      }

      .status.completed {
        background: #d4edda;
        color: #155724;
      }

      .status.failed {
        background: #f8d7da;
        color: #721c24;
      }

      .status.pending {
        background: #fff3cd;
        color: #856404;
      }

      .products-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .products-table thead {
        background: #f8f9fa;
      }

      .products-table th {
        text-align: left;
        padding: 15px;
        font-weight: 600;
        color: #0078d4;
        text-transform: uppercase;
        font-size: 0.85em;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #0078d4;
      }

      .products-table td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      .products-table tbody tr:hover {
        background: #f8f9ff;
      }

      .product-name {
        font-weight: 500;
        color: #333;
      }

      .product-sku {
        font-family: "Courier New", monospace;
        color: #666;
        font-size: 0.9em;
      }

      .product-price {
        font-weight: 600;
        color: #0078d4;
        font-size: 1.1em;
      }

      .product-unit {
        color: #666;
        font-size: 0.9em;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        font-size: 1.2em;
      }

      .loading:after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #721c24;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: #333;
      }

      .product-count {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>ProfitForge.ai - Results Viewer</h1>
      <p class="subtitle">Product Catalog Extraction Results</p>

      <div class="controls">
        <div class="form-group">
          <label for="functionUrl">Function App URL</label>
          <input
            type="text"
            id="functionUrl"
            value="http://localhost:7071"
            placeholder="https://..."
          />
        </div>
        <div class="form-group">
          <label for="resultId">Result ID (optional)</label>
          <input type="text" id="resultId" placeholder="Enter UUID" />
        </div>
        <div class="form-group">
          <label for="vendor">Vendor Name (optional)</label>
          <input type="text" id="vendor" placeholder="e.g., Hatteras" />
        </div>
        <button onclick="loadResults()">Load Results</button>
      </div>

      <div id="content">
        <div class="empty-state">
          <h3>üëÜ Enter parameters and click "Load Results"</h3>
          <p>View processed documents and extracted product catalogs</p>
        </div>
      </div>
    </div>

    <script>
      async function loadResults() {
        const content = document.getElementById("content");
        const baseUrl = document.getElementById("functionUrl").value.replace(/\/$/, "");
        const resultId = document.getElementById("resultId").value.trim();
        const vendor = document.getElementById("vendor").value.trim();

        let url = `${baseUrl}/api/getResults?limit=10`;
        if (resultId) url += `&resultId=${encodeURIComponent(resultId)}`;
        if (vendor) url += `&vendor=${encodeURIComponent(vendor)}`;

        content.innerHTML = '<div class="loading">Loading results</div>';

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const results = await response.json();

          if (results.length === 0) {
            content.innerHTML = `
              <div class="empty-state">
                <h3>No results found</h3>
                <p>Try adjusting your filters or upload a new document</p>
              </div>
            `;
            return;
          }

          content.innerHTML = results.map((result) => renderResultCard(result)).join("");
        } catch (error) {
          content.innerHTML = `
            <div class="error">
              <strong>Error loading results:</strong><br/>
              ${error.message}
            </div>
          `;
        }
      }

      function renderResultCard(result) {
        // Try llm_mapping_result first (new format), fallback to ai_model_analysis (legacy)
        let mappingResult = null;
        if (result.llm_mapping_result) {
          // If it's already an object, use it; if string, parse it
          mappingResult =
            typeof result.llm_mapping_result === "string"
              ? JSON.parse(result.llm_mapping_result)
              : result.llm_mapping_result;
        } else {
          mappingResult = result.ai_model_analysis;
        }

        const products = mappingResult?.products || [];
        const vendor = result.vendor_name || mappingResult?.vendor || "Unknown";

        const statusClass = result.processing_status || "pending";

        return `
          <div class="results-card">
            <div class="card-header">
              <h2>${vendor} <span class="product-count">${products.length} products</span></h2>
              <div class="card-meta">
                üìÑ ${result.document_path} ‚Ä¢ 
                üìÖ ${new Date(result.created_at).toLocaleString()}
              </div>
            </div>
            <div class="card-body">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Status</span>
                  <span class="info-value">
                    <span class="status ${statusClass}">${result.processing_status}</span>
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">Export Status</span>
                  <span class="info-value">
                    <span class="status ${result.export_status || "pending"}">${result.export_status || "pending"}</span>
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">Result ID</span>
                  <span class="info-value" style="font-size: 0.85em;">${result.result_id}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Vendor</span>
                  <span class="info-value">${result.vendor_name || vendor}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Document Name</span>
                  <span class="info-value" style="font-size: 0.9em;">${result.document_name}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">AI Model</span>
                  <span class="info-value">${result.ai_model_used || "N/A"}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Processing Version</span>
                  <span class="info-value">v${result.reprocessing_count || 0}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Doc Intel Cost</span>
                  <span class="info-value">$${(result.doc_intel_cost_usd || 0).toFixed(2)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">AI Model Cost</span>
                  <span class="info-value">$${(result.ai_model_cost_usd || 0).toFixed(4)}</span>
                </div>
              </div>

              <!-- Action Buttons for Workflow -->
              <div class="action-buttons">
                ${
                  result.processing_status === "completed" && result.export_status === "pending"
                    ? `<button class="success" onclick="confirmMapping('${result.result_id}')">‚úì Confirm & Export to Production</button>`
                    : ""
                }
                
                ${
                  result.processing_status === "completed" ||
                  result.processing_status === "ocr_complete"
                    ? `<button class="secondary" onclick="reprocessMapping('${result.result_id}')">üîÑ Rerun AI Mapping</button>`
                    : ""
                }
                
                <button class="danger" onclick="deleteDocument('${result.result_id}', '${result.vendor_name}')">üóëÔ∏è Delete Document</button>
              </div>

              ${
                products.length > 0
                  ? `
                <details style="margin-top: 20px;">
                  <summary style="cursor: pointer; font-weight: 600; padding: 10px; background: #f0f0f0; border-radius: 4px; user-select: none;">
                    üì¶ View Extracted Products (${products.length} items)
                  </summary>
                  <div style="margin-top: 15px; max-height: 500px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 4px;">
                    <table class="products-table">
                      <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                        <tr>
                          <th>SKU</th>
                          <th>Product Name</th>
                          <th>Price</th>
                          <th>Unit/Dimensions</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${products
                          .map(
                            (product) => `
                          <tr>
                            <td><span class="product-sku">${product.sku}</span></td>
                            <td><span class="product-name">${product.name}</span></td>
                            <td><span class="product-price">$${product.price.toFixed(2)}</span></td>
                            <td><span class="product-unit">${product.unit || "N/A"}</span></td>
                          </tr>
                        `
                          )
                          .join("")}
                      </tbody>
                    </table>
                  </div>
                </details>
              `
                  : `
                <div class="empty-state" style="margin-top: 20px;">
                  <h3>No products extracted</h3>
                  <p>${result.processing_status === "completed" ? "Document processed but no products found" : "Processing not yet complete"}</p>
                </div>
              `
              }
            </div>
          </div>
        `;
      }

      // Auto-load on page load if resultId in URL params
      window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const resultId = params.get("resultId");
        const vendor = params.get("vendor");

        if (resultId) {
          document.getElementById("resultId").value = resultId;
        }
        if (vendor) {
          document.getElementById("vendor").value = vendor;
        }

        if (resultId || vendor) {
          loadResults();
        }
      });

      // Action Handlers
      async function confirmMapping(documentId) {
        if (!confirm("Export products to production catalog? This action cannot be undone.")) {
          return;
        }

        const baseUrl = document.getElementById("functionUrl").value.replace(/\/$/, "");
        try {
          const response = await fetch(`${baseUrl}/api/confirmMapping`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ documentId }),
          });

          const data = await response.json();
          if (response.ok) {
            alert(
              `‚úÖ Success! ${data.productsExported} products exported to ${data.vendor} catalog.`
            );
            loadResults(); // Refresh
          } else {
            alert(`‚ùå Error: ${data.error || JSON.stringify(data)}`);
          }
        } catch (error) {
          alert(`‚ùå Network error: ${error.message}`);
        }
      }

      async function reprocessMapping(documentId) {
        if (
          !confirm(
            "Create new version for AI remapping? Original results preserved (immutable bronze-layer)."
          )
        ) {
          return;
        }

        const baseUrl = document.getElementById("functionUrl").value.replace(/\/$/, "");
        try {
          // Step 1: Create new version record
          const reprocessResponse = await fetch(`${baseUrl}/api/reprocessMapping`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ documentId }),
          });

          const reprocessData = await reprocessResponse.json();
          if (!reprocessResponse.ok) {
            alert(`‚ùå Error: ${reprocessData.error || JSON.stringify(reprocessData)}`);
            return;
          }

          const newDocumentId = reprocessData.newDocumentId;
          alert(`‚úÖ New version created (v${reprocessData.version})! Triggering AI mapping...`);

          // Step 2: Trigger AI mapper on NEW record
          const mapResponse = await fetch(`${baseUrl}/api/aiProductMapper`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ documentId: newDocumentId }),
          });

          const mapData = await mapResponse.json();
          if (mapResponse.ok) {
            alert(
              `‚úÖ Reprocessing complete! ${mapData.productCount} products extracted (v${reprocessData.version}).`
            );
            loadResults(); // Refresh
          } else {
            alert(`‚ùå Mapping error: ${mapData.error || JSON.stringify(mapData)}`);
          }
        } catch (error) {
          alert(`‚ùå Network error: ${error.message}`);
        }
      }

      async function deleteDocument(documentId, vendorName) {
        if (
          !confirm(
            `Delete document for ${vendorName}? This will remove all database records and blobs.`
          )
        ) {
          return;
        }

        const baseUrl = document.getElementById("functionUrl").value.replace(/\/$/, "");
        try {
          const response = await fetch(
            `${baseUrl}/api/deleteVendor?vendorId=${encodeURIComponent(vendorName)}`,
            {
              method: "DELETE",
            }
          );

          const data = await response.json();
          if (response.ok) {
            alert(
              `‚úÖ Deleted ${data.documentsDeleted} documents and ${data.blobsDeleted} blobs for ${vendorName}.`
            );
            loadResults(); // Refresh
          } else {
            alert(`‚ùå Error: ${data.error || JSON.stringify(data)}`);
          }
        } catch (error) {
          alert(`‚ùå Network error: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
